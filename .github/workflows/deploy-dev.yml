name: Deploy Development

on:
  push:
    branches:
      - dev
  workflow_dispatch: # Manual trigger

env:
  SERVER_IP: 72.61.142.109
  SERVER_USER: root
  PROJECT_PATH: ~/jargas-wajo-batang-kendal-dev
  GITHUB_REPO: https://github.com/irmanshidayat/jargas-wajo-batang-kendal.git

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ env.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Test SSH Connection
        run: |
          echo "üîç Testing SSH connection..."
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_IP }} 'echo "‚úÖ SSH connection successful!"' || {
            echo "‚ùå SSH connection failed!"
            echo "Please verify:"
            echo "1. Public key is added to server ~/.ssh/authorized_keys"
            echo "2. SSH_PRIVATE_KEY secret is correctly configured in GitHub"
            echo "3. Server is accessible: ${{ env.SERVER_IP }}"
            exit 1
          }

      - name: Deploy to Development Server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_IP }} bash -s << 'DEPLOY_SCRIPT'
            set -e
            
            # Expand ~ to full path
            PROJECT_PATH="${{ env.PROJECT_PATH }}"
            PROJECT_PATH=$(eval echo "$PROJECT_PATH")
            GITHUB_REPO="${{ env.GITHUB_REPO }}"
            
            echo "=========================================="
            echo "üöÄ Starting Deployment Process"
            echo "=========================================="
            echo "Project Path: $PROJECT_PATH"
            echo "GitHub Repo: $GITHUB_REPO"
            echo ""
            
            # Step 1: Verify project path exists
            echo "Step 1: Verifying project path..."
            if [ ! -d "$PROJECT_PATH" ]; then
              echo "‚ö†Ô∏è  Project path does not exist: $PROJECT_PATH"
              echo "Creating directory..."
              mkdir -p "$PROJECT_PATH" || {
                echo "‚ùå Error: Cannot create directory $PROJECT_PATH"
                exit 1
              }
              echo "‚úÖ Directory created"
            else
              echo "‚úÖ Project path exists"
            fi
            
            # Step 2: Navigate to project directory
            echo ""
            echo "Step 2: Navigating to project directory..."
            cd "$PROJECT_PATH" || {
              echo "‚ùå Error: Cannot cd to $PROJECT_PATH"
              exit 1
            }
            echo "‚úÖ Current directory: $(pwd)"
            
            # Step 3: Check if Git repository exists, if not clone it
            echo ""
            echo "Step 3: Checking Git repository..."
            if [ ! -d ".git" ]; then
              echo "‚ö†Ô∏è  Git repository not found in $PROJECT_PATH"
              echo "Checking if directory is empty..."
              FILE_COUNT=$(find . -maxdepth 1 -not -name '.' -not -name '..' 2>/dev/null | wc -l)
              if [ "$FILE_COUNT" -gt 0 ]; then
                echo "‚ö†Ô∏è  Directory is not empty ($FILE_COUNT items found)"
                echo "Files in directory:"
                ls -la | head -10
                echo ""
                echo "Initializing git repository in existing directory..."
                git init || {
                  echo "‚ùå Error: Cannot initialize git repository"
                  exit 1
                }
                # Check if remote already exists
                if ! git remote get-url origin >/dev/null 2>&1; then
                  git remote add origin "$GITHUB_REPO" || {
                    echo "‚ùå Error: Cannot add remote origin"
                    exit 1
                  }
                else
                  echo "‚ö†Ô∏è  Remote origin already exists, updating URL..."
                  git remote set-url origin "$GITHUB_REPO" || {
                    echo "‚ö†Ô∏è  Warning: Cannot update remote URL"
                  }
                fi
                echo "‚úÖ Git repository initialized"
              else
                echo "Directory is empty, cloning repository..."
                git clone -b dev "$GITHUB_REPO" . || {
                  echo "‚ùå Error: Cannot clone repository"
                  exit 1
                }
                echo "‚úÖ Repository cloned successfully"
              fi
            else
              echo "‚úÖ Git repository found"
            fi
            
            # Step 4: Pull latest code
            echo ""
            echo "Step 4: Pulling latest code from dev branch..."
            # Fetch latest changes
            if ! git fetch origin 2>&1; then
              echo "‚ö†Ô∏è  Warning: git fetch failed, checking remote..."
              if ! git remote get-url origin >/dev/null 2>&1; then
                echo "‚ö†Ô∏è  No remote origin found, adding remote..."
                git remote add origin "$GITHUB_REPO" || {
                  echo "‚ùå Error: Cannot add remote origin"
                  exit 1
                }
                git fetch origin || {
                  echo "‚ùå Error: Cannot fetch from remote"
                  exit 1
                }
              fi
            fi
            
            # Checkout dev branch
            if ! git checkout dev 2>&1; then
              echo "‚ö†Ô∏è  Cannot checkout dev branch, trying to create it from origin/dev..."
              git checkout -b dev origin/dev 2>&1 || {
                echo "‚ùå Error: Cannot checkout or create dev branch"
                echo "Current branch: $(git branch --show-current 2>/dev/null || echo 'unknown')"
                echo "Available branches:"
                git branch -a || true
                exit 1
              }
            fi
            
            # Reset to origin/dev
            if ! git reset --hard origin/dev 2>&1; then
              echo "‚ùå Error: Cannot reset to origin/dev"
              echo "Please check if dev branch exists in remote"
              echo "Current branch: $(git branch --show-current 2>/dev/null || echo 'unknown')"
              echo "Remote branches:"
              git branch -r || true
              exit 1
            fi
            echo "‚úÖ Code updated to latest dev branch"
            echo "   Commit: $(git rev-parse --short HEAD 2>/dev/null || echo 'unknown')"
            
            # Step 5: Verify and create environment files if needed
            echo ""
            echo "Step 5: Verifying environment files..."
            
            # Check and create .env.dev from template
            if [ ! -f .env.dev ]; then
              echo "‚ö†Ô∏è  .env.dev not found in project root"
              if [ -f env.dev.example ]; then
                echo "Creating .env.dev from env.dev.example template..."
                cp env.dev.example .env.dev || {
                  echo "‚ùå Error: Cannot create .env.dev from template"
                  exit 1
                }
                echo "‚úÖ .env.dev created from template"
                echo "‚ö†Ô∏è  WARNING: Please review and update .env.dev with correct values!"
                echo "   Especially SECRET_KEY, DB_PASSWORD, and other sensitive values"
              else
                echo "‚ùå Error: .env.dev not found and env.dev.example template also not found"
                echo "Current directory: $(pwd)"
                echo "Files in current directory:"
                ls -la | head -10
                exit 1
              fi
            else
              echo "‚úÖ .env.dev found"
            fi
            
            # Check and create backend/.env.dev from template
            if [ ! -f backend/.env.dev ]; then
              echo "‚ö†Ô∏è  backend/.env.dev not found"
              if [ -f backend/env.dev.example ]; then
                echo "Creating backend/.env.dev from backend/env.dev.example template..."
                cp backend/env.dev.example backend/.env.dev || {
                  echo "‚ùå Error: Cannot create backend/.env.dev from template"
                  exit 1
                }
                echo "‚úÖ backend/.env.dev created from template"
                echo "‚ö†Ô∏è  WARNING: Please review and update backend/.env.dev with correct values!"
              elif [ -f env.dev.example ]; then
                echo "Creating backend/.env.dev from root env.dev.example template..."
                cp env.dev.example backend/.env.dev || {
                  echo "‚ùå Error: Cannot create backend/.env.dev from template"
                  exit 1
                }
                echo "‚úÖ backend/.env.dev created from root template"
                echo "‚ö†Ô∏è  WARNING: Please review and update backend/.env.dev with correct values!"
              else
                echo "‚ùå Error: backend/.env.dev not found and no template available"
                echo "Files in backend directory:"
                ls -la backend/ | head -10 || echo "backend/ directory does not exist"
                exit 1
              fi
            else
              echo "‚úÖ backend/.env.dev found"
            fi
            
            echo "‚úÖ Environment files verified/created"
            
            # Step 6: Verify docker-compose file exists
            echo ""
            echo "Step 6: Verifying docker-compose.dev.yml..."
            if [ ! -f docker-compose.dev.yml ]; then
              echo "‚ùå Error: docker-compose.dev.yml not found"
              exit 1
            fi
            echo "‚úÖ docker-compose.dev.yml found"
            
            # Step 7: Build Docker containers
            echo ""
            echo "Step 7: Building Docker containers (development)..."
            if ! docker-compose -f docker-compose.dev.yml --env-file .env.dev build --no-cache 2>&1; then
              echo "‚ùå Error: Docker build failed"
              echo "Checking Docker status..."
              docker ps -a || echo "Docker not accessible"
              exit 1
            fi
            echo "‚úÖ Docker build completed"
            
            # Step 8: Stop existing containers
            echo ""
            echo "Step 8: Stopping existing containers..."
            docker-compose -f docker-compose.dev.yml --env-file .env.dev down 2>&1 || {
              echo "‚ö†Ô∏è  Warning: Some containers may not have stopped cleanly"
            }
            echo "‚úÖ Containers stopped"
            
            # Step 9: Start containers
            echo ""
            echo "Step 9: Starting containers..."
            if ! docker-compose -f docker-compose.dev.yml --env-file .env.dev up -d 2>&1; then
              echo "‚ùå Error: Failed to start containers"
              echo "Checking container status..."
              docker-compose -f docker-compose.dev.yml --env-file .env.dev ps || true
              echo "Checking logs..."
              docker-compose -f docker-compose.dev.yml --env-file .env.dev logs --tail=50 || true
              exit 1
            fi
            echo "‚úÖ Containers started"
            
            # Step 10: Wait for services
            echo ""
            echo "Step 10: Waiting for services to be ready..."
            sleep 30
            
            # Step 11: Check container status
            echo ""
            echo "Step 11: Checking container status..."
            docker-compose -f docker-compose.dev.yml --env-file .env.dev ps
            
            # Check if containers are running
            RUNNING_CONTAINERS=$(docker-compose -f docker-compose.dev.yml --env-file .env.dev ps -q | wc -l)
            if [ "$RUNNING_CONTAINERS" -eq 0 ]; then
              echo "‚ö†Ô∏è  Warning: No containers are running"
              echo "Checking logs for errors..."
              docker-compose -f docker-compose.dev.yml --env-file .env.dev logs --tail=100 || true
            else
              echo "‚úÖ $RUNNING_CONTAINERS container(s) running"
            fi
            
            echo ""
            echo "=========================================="
            echo "‚úÖ Deployment completed!"
            echo "=========================================="
            echo "üåê Frontend: https://devjargas.ptkiansantang.com"
            echo "üîó Backend: https://devjargas.ptkiansantang.com/api/v1/health"
            echo ""
          DEPLOY_SCRIPT

      - name: Health Check
        run: |
          sleep 10
          curl -f https://devjargas.ptkiansantang.com/api/v1/health || exit 1

      - name: Deployment Summary
        run: |
          echo "## ‚úÖ Development Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend**: https://devjargas.ptkiansantang.com" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend**: https://devjargas.ptkiansantang.com/api/v1/health" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed at**: $(date)" >> $GITHUB_STEP_SUMMARY

