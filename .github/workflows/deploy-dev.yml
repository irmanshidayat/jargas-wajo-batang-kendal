name: Deploy Development

on:
  push:
    branches:
      - dev
  workflow_dispatch: # Manual trigger

env:
  SERVER_IP: 72.61.142.109
  SERVER_USER: root
  PROJECT_PATH: ~/jargas-wajo-batang-kendal-dev

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ env.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Test SSH Connection
        run: |
          echo "üîç Testing SSH connection..."
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_IP }} 'echo "‚úÖ SSH connection successful!"' || {
            echo "‚ùå SSH connection failed!"
            echo "Please verify:"
            echo "1. Public key is added to server ~/.ssh/authorized_keys"
            echo "2. SSH_PRIVATE_KEY secret is correctly configured in GitHub"
            echo "3. Server is accessible: ${{ env.SERVER_IP }}"
            exit 1
          }

      - name: Deploy to Development Server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_IP }} << 'EOF'
            set -e
            cd ${{ env.PROJECT_PATH }}
            
            echo "üì• Pulling latest code from dev branch..."
            git fetch origin
            git checkout dev
            git reset --hard origin/dev
            
            echo "üîç Verifying environment files..."
            if [ ! -f .env.dev ] || [ ! -f backend/.env.dev ]; then
              echo "‚ùå Error: .env.dev files not found!"
              echo "Please ensure .env.dev and backend/.env.dev exist on server"
              exit 1
            fi
            echo "‚úÖ Environment files found"
            
            echo "üî® Building Docker containers (development)..."
            docker-compose -f docker-compose.dev.yml --env-file .env.dev build --no-cache
            
            echo "üõë Stopping containers..."
            docker-compose -f docker-compose.dev.yml --env-file .env.dev down
            
            echo "üöÄ Starting containers..."
            docker-compose -f docker-compose.dev.yml --env-file .env.dev up -d
            
            echo "‚è≥ Waiting for services to be ready..."
            sleep 30
            
            echo "üìã Checking container status..."
            docker-compose -f docker-compose.dev.yml --env-file .env.dev ps
            
            echo "‚úÖ Deployment completed!"
            echo "üåê Frontend: https://devjargas.ptkiansantang.com"
            echo "üîó Backend: https://devjargas.ptkiansantang.com/api/v1/health"
          EOF

      - name: Health Check
        run: |
          sleep 10
          curl -f https://devjargas.ptkiansantang.com/api/v1/health || exit 1

      - name: Deployment Summary
        run: |
          echo "## ‚úÖ Development Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend**: https://devjargas.ptkiansantang.com" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend**: https://devjargas.ptkiansantang.com/api/v1/health" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed at**: $(date)" >> $GITHUB_STEP_SUMMARY

