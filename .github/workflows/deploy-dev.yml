name: Deploy Development

on:
  push:
    branches:
      - dev
  workflow_dispatch: # Manual trigger

env:
  SERVER_IP: 72.61.142.109
  SERVER_USER: root
  PROJECT_PATH: ~/jargas-wajo-batang-kendal-dev

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ env.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Test SSH Connection
        run: |
          echo "üîç Testing SSH connection..."
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_IP }} 'echo "‚úÖ SSH connection successful!"' || {
            echo "‚ùå SSH connection failed!"
            echo "Please verify:"
            echo "1. Public key is added to server ~/.ssh/authorized_keys"
            echo "2. SSH_PRIVATE_KEY secret is correctly configured in GitHub"
            echo "3. Server is accessible: ${{ env.SERVER_IP }}"
            exit 1
          }

      - name: Deploy to Development Server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_IP }} << 'EOF'
            set -e
            
            echo "=========================================="
            echo "üöÄ Starting Deployment Process"
            echo "=========================================="
            
            # Step 1: Verify project path exists
            echo ""
            echo "Step 1: Verifying project path..."
            if [ ! -d "${{ env.PROJECT_PATH }}" ]; then
              echo "‚ùå Error: Project path does not exist: ${{ env.PROJECT_PATH }}"
              echo "Please create the directory first or check the path"
              exit 1
            fi
            echo "‚úÖ Project path exists"
            
            # Step 2: Navigate to project directory
            echo ""
            echo "Step 2: Navigating to project directory..."
            cd ${{ env.PROJECT_PATH }} || {
              echo "‚ùå Error: Cannot cd to ${{ env.PROJECT_PATH }}"
              exit 1
            }
            echo "‚úÖ Current directory: $(pwd)"
            
            # Step 3: Pull latest code
            echo ""
            echo "Step 3: Pulling latest code from dev branch..."
            if ! git fetch origin 2>&1; then
              echo "‚ö†Ô∏è  Warning: git fetch failed, continuing anyway..."
            fi
            
            if ! git checkout dev 2>&1; then
              echo "‚ùå Error: Cannot checkout dev branch"
              echo "Current branch: $(git branch --show-current 2>/dev/null || echo 'unknown')"
              exit 1
            fi
            
            if ! git reset --hard origin/dev 2>&1; then
              echo "‚ùå Error: Cannot reset to origin/dev"
              echo "Please check if dev branch exists in remote"
              exit 1
            fi
            echo "‚úÖ Code updated to latest dev branch"
            echo "   Commit: $(git rev-parse --short HEAD 2>/dev/null || echo 'unknown')"
            
            # Step 4: Verify environment files
            echo ""
            echo "Step 4: Verifying environment files..."
            if [ ! -f .env.dev ]; then
              echo "‚ùå Error: .env.dev not found in project root"
              echo "Current directory: $(pwd)"
              echo "Files in current directory:"
              ls -la | head -10
              exit 1
            fi
            
            if [ ! -f backend/.env.dev ]; then
              echo "‚ùå Error: backend/.env.dev not found"
              echo "Files in backend directory:"
              ls -la backend/ | head -10 || echo "backend/ directory does not exist"
              exit 1
            fi
            echo "‚úÖ Environment files found"
            
            # Step 5: Verify docker-compose file exists
            echo ""
            echo "Step 5: Verifying docker-compose.dev.yml..."
            if [ ! -f docker-compose.dev.yml ]; then
              echo "‚ùå Error: docker-compose.dev.yml not found"
              exit 1
            fi
            echo "‚úÖ docker-compose.dev.yml found"
            
            # Step 6: Build Docker containers
            echo ""
            echo "Step 6: Building Docker containers (development)..."
            if ! docker-compose -f docker-compose.dev.yml --env-file .env.dev build --no-cache 2>&1; then
              echo "‚ùå Error: Docker build failed"
              echo "Checking Docker status..."
              docker ps -a || echo "Docker not accessible"
              exit 1
            fi
            echo "‚úÖ Docker build completed"
            
            # Step 7: Stop existing containers
            echo ""
            echo "Step 7: Stopping existing containers..."
            docker-compose -f docker-compose.dev.yml --env-file .env.dev down 2>&1 || {
              echo "‚ö†Ô∏è  Warning: Some containers may not have stopped cleanly"
            }
            echo "‚úÖ Containers stopped"
            
            # Step 8: Start containers
            echo ""
            echo "Step 8: Starting containers..."
            if ! docker-compose -f docker-compose.dev.yml --env-file .env.dev up -d 2>&1; then
              echo "‚ùå Error: Failed to start containers"
              echo "Checking container status..."
              docker-compose -f docker-compose.dev.yml --env-file .env.dev ps || true
              echo "Checking logs..."
              docker-compose -f docker-compose.dev.yml --env-file .env.dev logs --tail=50 || true
              exit 1
            fi
            echo "‚úÖ Containers started"
            
            # Step 9: Wait for services
            echo ""
            echo "Step 9: Waiting for services to be ready..."
            sleep 30
            
            # Step 10: Check container status
            echo ""
            echo "Step 10: Checking container status..."
            docker-compose -f docker-compose.dev.yml --env-file .env.dev ps
            
            # Check if containers are running
            RUNNING_CONTAINERS=$(docker-compose -f docker-compose.dev.yml --env-file .env.dev ps -q | wc -l)
            if [ "$RUNNING_CONTAINERS" -eq 0 ]; then
              echo "‚ö†Ô∏è  Warning: No containers are running"
              echo "Checking logs for errors..."
              docker-compose -f docker-compose.dev.yml --env-file .env.dev logs --tail=100 || true
            else
              echo "‚úÖ $RUNNING_CONTAINERS container(s) running"
            fi
            
            echo ""
            echo "=========================================="
            echo "‚úÖ Deployment completed!"
            echo "=========================================="
            echo "üåê Frontend: https://devjargas.ptkiansantang.com"
            echo "üîó Backend: https://devjargas.ptkiansantang.com/api/v1/health"
            echo ""
          EOF

      - name: Health Check
        run: |
          sleep 10
          curl -f https://devjargas.ptkiansantang.com/api/v1/health || exit 1

      - name: Deployment Summary
        run: |
          echo "## ‚úÖ Development Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend**: https://devjargas.ptkiansantang.com" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend**: https://devjargas.ptkiansantang.com/api/v1/health" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed at**: $(date)" >> $GITHUB_STEP_SUMMARY

