name: Deploy Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # Manual trigger

env:
  SERVER_IP: 72.61.142.109
  SERVER_USER: root
  PROJECT_PATH: ~/jargas-wajo-batang-kendal
  GITHUB_REPO: https://github.com/irmanshidayat/jargas-wajo-batang-kendal.git

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ env.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Test SSH Connection
        run: |
          echo "üîç Testing SSH connection..."
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_IP }} 'echo "‚úÖ SSH connection successful!"' || {
            echo "‚ùå SSH connection failed!"
            echo "Please verify:"
            echo "1. Public key is added to server ~/.ssh/authorized_keys"
            echo "2. SSH_PRIVATE_KEY secret is correctly configured in GitHub"
            echo "3. Server is accessible: ${{ env.SERVER_IP }}"
            exit 1
          }

      - name: Deploy to Production Server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_IP }} bash -s << 'DEPLOY_SCRIPT'
            set -e
            
            # Expand ~ to full path
            PROJECT_PATH="${{ env.PROJECT_PATH }}"
            PROJECT_PATH=$(eval echo "$PROJECT_PATH")
            GITHUB_REPO="${{ env.GITHUB_REPO }}"
            
            echo "=========================================="
            echo "üöÄ Starting Deployment Process"
            echo "=========================================="
            echo "Project Path: $PROJECT_PATH"
            echo "GitHub Repo: $GITHUB_REPO"
            echo ""
            
            # Step 1: Verify project path exists
            echo "Step 1: Verifying project path..."
            if [ ! -d "$PROJECT_PATH" ]; then
              echo "‚ö†Ô∏è  Project path does not exist: $PROJECT_PATH"
              echo "Creating directory..."
              mkdir -p "$PROJECT_PATH" || {
                echo "‚ùå Error: Cannot create directory $PROJECT_PATH"
                exit 1
              }
              echo "‚úÖ Directory created"
            else
              echo "‚úÖ Project path exists"
            fi
            
            # Step 2: Navigate to project directory
            echo ""
            echo "Step 2: Navigating to project directory..."
            cd "$PROJECT_PATH" || {
              echo "‚ùå Error: Cannot cd to $PROJECT_PATH"
              exit 1
            }
            echo "‚úÖ Current directory: $(pwd)"
            
            # Step 3: Check if Git repository exists, if not clone it
            echo ""
            echo "Step 3: Checking Git repository..."
            if [ ! -d ".git" ]; then
              echo "‚ö†Ô∏è  Git repository not found in $PROJECT_PATH"
              echo "Checking if directory is empty..."
              FILE_COUNT=$(find . -maxdepth 1 -not -name '.' -not -name '..' 2>/dev/null | wc -l)
              if [ "$FILE_COUNT" -gt 0 ]; then
                echo "‚ö†Ô∏è  Directory is not empty ($FILE_COUNT items found)"
                echo "Files in directory:"
                ls -la | head -10
                echo ""
                echo "Initializing git repository in existing directory..."
                git init || {
                  echo "‚ùå Error: Cannot initialize git repository"
                  exit 1
                }
                # Check if remote already exists
                if ! git remote get-url origin >/dev/null 2>&1; then
                  git remote add origin "$GITHUB_REPO" || {
                    echo "‚ùå Error: Cannot add remote origin"
                    exit 1
                  }
                else
                  echo "‚ö†Ô∏è  Remote origin already exists, updating URL..."
                  git remote set-url origin "$GITHUB_REPO" || {
                    echo "‚ö†Ô∏è  Warning: Cannot update remote URL"
                  }
                fi
                echo "‚úÖ Git repository initialized"
              else
                echo "Directory is empty, cloning repository..."
                git clone -b main "$GITHUB_REPO" . || {
                  echo "‚ùå Error: Cannot clone repository"
                  exit 1
                }
                echo "‚úÖ Repository cloned successfully"
              fi
            else
              echo "‚úÖ Git repository found"
            fi
            
            # Step 4: Pull latest code
            echo ""
            echo "Step 4: Pulling latest code from main branch..."
            # Fetch latest changes
            if ! git fetch origin 2>&1; then
              echo "‚ö†Ô∏è  Warning: git fetch failed, checking remote..."
              if ! git remote get-url origin >/dev/null 2>&1; then
                echo "‚ö†Ô∏è  No remote origin found, adding remote..."
                git remote add origin "$GITHUB_REPO" || {
                  echo "‚ùå Error: Cannot add remote origin"
                  exit 1
                }
                git fetch origin || {
                  echo "‚ùå Error: Cannot fetch from remote"
                  exit 1
                }
              fi
            fi
            
            # Checkout main branch
            if ! git checkout main 2>&1; then
              echo "‚ö†Ô∏è  Cannot checkout main branch, trying to create it from origin/main..."
              git checkout -b main origin/main 2>&1 || {
                echo "‚ùå Error: Cannot checkout or create main branch"
                echo "Current branch: $(git branch --show-current 2>/dev/null || echo 'unknown')"
                echo "Available branches:"
                git branch -a || true
                exit 1
              }
            fi
            
            # Reset to origin/main
            if ! git reset --hard origin/main 2>&1; then
              echo "‚ùå Error: Cannot reset to origin/main"
              echo "Please check if main branch exists in remote"
              echo "Current branch: $(git branch --show-current 2>/dev/null || echo 'unknown')"
              echo "Remote branches:"
              git branch -r || true
              exit 1
            fi
            echo "‚úÖ Code updated to latest main branch"
            echo "   Commit: $(git rev-parse --short HEAD 2>/dev/null || echo 'unknown')"
            
            # Step 5: Verify and create environment files if needed
            echo ""
            echo "Step 5: Verifying environment files..."
            
            # Check and create .env from template
            if [ ! -f .env ]; then
              echo "‚ö†Ô∏è  .env not found in project root"
              if [ -f env.example ]; then
                echo "Creating .env from env.example template..."
                cp env.example .env || {
                  echo "‚ùå Error: Cannot create .env from template"
                  exit 1
                }
                echo "‚úÖ .env created from template"
                echo "‚ö†Ô∏è  WARNING: Please review and update .env with correct values!"
                echo "   Especially SECRET_KEY, DB_PASSWORD, and other sensitive values"
              else
                echo "‚ùå Error: .env not found and env.example template also not found"
                echo "Current directory: $(pwd)"
                echo "Files in current directory:"
                ls -la | head -10
                exit 1
              fi
            else
              echo "‚úÖ .env found"
            fi
            
            # Check and create backend/.env from template
            if [ ! -f backend/.env ]; then
              echo "‚ö†Ô∏è  backend/.env not found"
              if [ -f backend/env.example ]; then
                echo "Creating backend/.env from backend/env.example template..."
                cp backend/env.example backend/.env || {
                  echo "‚ùå Error: Cannot create backend/.env from template"
                  exit 1
                }
                echo "‚úÖ backend/.env created from template"
                echo "‚ö†Ô∏è  WARNING: Please review and update backend/.env with correct values!"
              elif [ -f env.example ]; then
                echo "Creating backend/.env from root env.example template..."
                cp env.example backend/.env || {
                  echo "‚ùå Error: Cannot create backend/.env from template"
                  exit 1
                }
                echo "‚úÖ backend/.env created from root template"
                echo "‚ö†Ô∏è  WARNING: Please review and update backend/.env with correct values!"
              else
                echo "‚ùå Error: backend/.env not found and no template available"
                echo "Files in backend directory:"
                ls -la backend/ | head -10 || echo "backend/ directory does not exist"
                exit 1
              fi
            else
              echo "‚úÖ backend/.env found"
            fi
            
            echo "‚úÖ Environment files verified/created"
            
            # Step 6: Setup Backend (without Docker)
            echo ""
            echo "Step 6: Setting up Backend (without Docker)..."
            cd backend || {
              echo "‚ùå Error: Cannot cd to backend directory"
              exit 1
            }
            
            # Check Python
            if ! command -v python3 &> /dev/null; then
              echo "‚ùå Error: Python3 not found"
              echo "Please install Python 3.11 or higher"
              exit 1
            fi
            PYTHON_VERSION=$(python3 --version)
            echo "‚úÖ Found: $PYTHON_VERSION"
            
            # Install required system packages for Python venv
            echo "Installing required system packages..."
            if command -v apt-get &> /dev/null; then
              # Debian/Ubuntu
              apt-get update -qq > /dev/null 2>&1
              apt-get install -y -qq python3-venv python3-pip python3-dev build-essential > /dev/null 2>&1 || {
                echo "‚ö†Ô∏è  Warning: Some packages may not have installed (non-fatal)"
              }
              echo "‚úÖ System packages installed/verified"
            elif command -v yum &> /dev/null; then
              # CentOS/RHEL
              yum install -y -q python3-venv python3-pip python3-devel gcc > /dev/null 2>&1 || {
                echo "‚ö†Ô∏è  Warning: Some packages may not have installed (non-fatal)"
              }
              echo "‚úÖ System packages installed/verified"
            else
              echo "‚ö†Ô∏è  Warning: Package manager not detected, skipping system package installation"
            fi
            
            # Setup virtual environment
            VENV_VALID=false
            if [ -d "venv" ]; then
              # Check if venv is valid
              if [ -f "venv/bin/activate" ] && [ -f "venv/bin/python3" ]; then
                echo "‚úÖ Virtual environment exists and appears valid"
                VENV_VALID=true
              else
                echo "‚ö†Ô∏è  Virtual environment exists but appears invalid/corrupt"
                echo "Removing invalid virtual environment..."
                rm -rf venv
                echo "‚úÖ Invalid virtual environment removed"
                VENV_VALID=false
              fi
            fi
            
            if [ "$VENV_VALID" = false ]; then
              echo "Creating virtual environment..."
              python3 -m venv venv || {
                echo "‚ùå Error: Cannot create virtual environment"
                echo "Trying alternative method..."
                # Try with --without-pip if ensurepip is not available
                python3 -m venv --without-pip venv || {
                  echo "‚ùå Error: Cannot create virtual environment even with --without-pip"
                  echo "Please ensure python3-venv package is installed on the server"
                  exit 1
                }
                echo "‚úÖ Virtual environment created (without pip)"
                # Install pip manually
                if [ -f "venv/bin/activate" ]; then
                  source venv/bin/activate
                  curl -sS https://bootstrap.pypa.io/get-pip.py | python3 || {
                    echo "‚ùå Error: Cannot install pip"
                    exit 1
                  }
                  deactivate
                  echo "‚úÖ Pip installed in virtual environment"
                else
                  echo "‚ùå Error: Cannot activate venv to install pip"
                  exit 1
                fi
              }
              echo "‚úÖ Virtual environment created"
            fi
            
            # Verify venv is valid before proceeding
            if [ ! -f "venv/bin/activate" ]; then
              echo "‚ùå Error: Virtual environment activate script not found"
              echo "Removing invalid venv and retrying..."
              rm -rf venv
              python3 -m venv venv || {
                echo "‚ùå Error: Cannot recreate virtual environment"
                exit 1
              }
            fi
            
            # Activate venv and install dependencies
            echo "Installing/updating dependencies..."
            source venv/bin/activate || {
              echo "‚ùå Error: Cannot activate virtual environment"
              echo "Checking venv structure..."
              ls -la venv/bin/ || true
              exit 1
            }
            pip install --upgrade pip setuptools wheel > /dev/null 2>&1
            pip install -r requirements.txt || {
              echo "‚ùå Error: Failed to install dependencies"
              exit 1
            }
            echo "‚úÖ Dependencies installed"
            deactivate
            
            # Step 7: Stop existing backend process (if running)
            echo ""
            echo "Step 7: Stopping existing backend process..."
            pkill -f "python.*run.py" || echo "No existing backend process found"
            sleep 2
            echo "‚úÖ Backend process stopped"
            
            # Step 8: Start backend as systemd service or background process
            echo ""
            echo "Step 8: Starting backend service..."
            cd "$PROJECT_PATH/backend" || exit 1
            source venv/bin/activate
            
            # Start backend in background
            nohup python3 run.py > backend.log 2>&1 &
            BACKEND_PID=$!
            echo $BACKEND_PID > backend.pid
            echo "‚úÖ Backend started (PID: $BACKEND_PID)"
            deactivate
            cd "$PROJECT_PATH" || exit 1
            
            # Step 9: Verify docker-compose.frontend.yml exists
            echo ""
            echo "Step 9: Verifying docker-compose.frontend.yml..."
            if [ ! -f docker-compose.frontend.yml ]; then
              echo "‚ùå Error: docker-compose.frontend.yml not found"
              exit 1
            fi
            echo "‚úÖ docker-compose.frontend.yml found"
            
            # Step 10: Build and start Frontend Docker container
            echo ""
            echo "Step 10: Building Frontend Docker container..."
            if ! docker-compose -f docker-compose.frontend.yml --env-file .env build --no-cache 2>&1; then
              echo "‚ùå Error: Docker build failed"
              echo "Checking Docker status..."
              docker ps -a || echo "Docker not accessible"
              exit 1
            fi
            echo "‚úÖ Docker build completed"
            
            # Step 11: Stop existing frontend container
            echo ""
            echo "Step 11: Stopping existing frontend container..."
            docker-compose -f docker-compose.frontend.yml --env-file .env down 2>&1 || {
              echo "‚ö†Ô∏è  Warning: Some containers may not have stopped cleanly"
            }
            echo "‚úÖ Frontend container stopped"
            
            # Step 12: Start frontend container
            echo ""
            echo "Step 12: Starting frontend container..."
            if ! docker-compose -f docker-compose.frontend.yml --env-file .env up -d 2>&1; then
              echo "‚ùå Error: Failed to start frontend container"
              echo "Checking container status..."
              docker-compose -f docker-compose.frontend.yml --env-file .env ps || true
              echo "Checking logs..."
              docker-compose -f docker-compose.frontend.yml --env-file .env logs --tail=50 || true
              exit 1
            fi
            echo "‚úÖ Frontend container started"
            
            # Step 13: Wait for services
            echo ""
            echo "Step 13: Waiting for services to be ready..."
            sleep 30
            
            # Step 14: Check services status
            echo ""
            echo "Step 14: Checking services status..."
            
            # Check backend
            if [ -f backend/backend.pid ]; then
              BACKEND_PID=$(cat backend/backend.pid)
              if ps -p $BACKEND_PID > /dev/null 2>&1; then
                echo "‚úÖ Backend is running (PID: $BACKEND_PID)"
                echo "   Testing backend health..."
                sleep 5
                if curl -f -s http://localhost:8000/health > /dev/null 2>&1; then
                  echo "‚úÖ Backend health check passed"
                else
                  echo "‚ö†Ô∏è  Warning: Backend health check failed"
                  echo "   Backend may still be starting up..."
                fi
              else
                echo "‚ö†Ô∏è  Warning: Backend process not found"
                echo "Checking backend logs..."
                tail -50 backend/backend.log || true
              fi
            else
              echo "‚ö†Ô∏è  Warning: Backend PID file not found"
            fi
            
            # Check frontend container
            docker-compose -f docker-compose.frontend.yml --env-file .env ps
            
            RUNNING_CONTAINERS=$(docker-compose -f docker-compose.frontend.yml --env-file .env ps -q | wc -l)
            if [ "$RUNNING_CONTAINERS" -eq 0 ]; then
              echo "‚ö†Ô∏è  Warning: No frontend containers are running"
              echo "Checking logs for errors..."
              docker-compose -f docker-compose.frontend.yml --env-file .env logs --tail=100 || true
            else
              echo "‚úÖ $RUNNING_CONTAINERS frontend container(s) running"
            fi
            
            echo ""
            echo "=========================================="
            echo "‚úÖ Deployment completed!"
            echo "=========================================="
            echo "üåê Frontend: https://jargas.ptkiansantang.com:453"
            echo "üîó Backend: http://localhost:8000"
            echo "üîó Backend API: https://jargas.ptkiansantang.com:453/api/v1/health"
            echo ""
            echo "üìù Note:"
            echo "   - Backend berjalan tanpa Docker di port 8000"
            echo "   - Frontend berjalan dengan Docker"
            echo "   - Nginx akan proxy request ke backend lokal"
            echo ""
          DEPLOY_SCRIPT

      - name: Health Check
        run: |
          echo "üîç Waiting for services to be fully ready..."
          sleep 15
          echo "üè• Testing health endpoint..."
          # Try /health first (nginx static endpoint)
          if curl -f -s https://jargas.ptkiansantang.com:453/health > /dev/null 2>&1; then
            echo "‚úÖ Health check passed: /health"
          # Fallback to /api/v1/health (backend endpoint)
          elif curl -f -s https://jargas.ptkiansantang.com:453/api/v1/health > /dev/null 2>&1; then
            echo "‚úÖ Health check passed: /api/v1/health"
          else
            echo "‚ùå Health check failed for both endpoints"
            echo "Checking /health response:"
            curl -v https://jargas.ptkiansantang.com:453/health || true
            echo ""
            echo "Checking /api/v1/health response:"
            curl -v https://jargas.ptkiansantang.com:453/api/v1/health || true
            exit 1
          fi

      - name: Deployment Summary
        run: |
          echo "## ‚úÖ Production Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend**: https://jargas.ptkiansantang.com:453" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend**: http://localhost:8000" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend API**: https://jargas.ptkiansantang.com:453/api/v1/health" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed at**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìù Architecture" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: Running without Docker (Python)" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: Running with Docker" >> $GITHUB_STEP_SUMMARY
          echo "- Database: MySQL (server)" >> $GITHUB_STEP_SUMMARY

