name: Deploy Backend - Development

on:
  push:
    branches:
      - dev
    paths:
      - 'backend/**'
  workflow_dispatch:

env:
  SERVER_HOST: 72.61.142.109
  SERVER_USER: root
  DEPLOY_PATH: /var/www/jargas-backend-dev
  PYTHON_VERSION: '3.12'

jobs:
  deploy:
    name: Deploy to Development Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies (CI check)
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests (if available)
        working-directory: ./backend
        run: |
          if [ -f "pytest.ini" ] || [ -d "app/tests" ]; then
            pip install pytest pytest-asyncio httpx
            pytest app/tests/ -v || echo "Tests failed but continuing deployment"
          else
            echo "No tests found, skipping..."
          fi
        continue-on-error: true

      - name: Cleanup server (Docker, cache, old backups)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            
            echo "üßπ Starting cleanup process..."
            
            # Docker cleanup - hapus container, image, cache yang tidak terpakai
            if command -v docker &> /dev/null; then
              echo "üê≥ Cleaning up Docker..."
              # Hapus container yang sudah stopped
              docker container prune -f || true
              # Hapus image yang tidak digunakan (dangling)
              docker image prune -af || true
              # Hapus volume yang tidak digunakan
              docker volume prune -f || true
              # Hapus network yang tidak digunakan
              docker network prune -f || true
              # Hapus build cache
              docker builder prune -af || true
              # Hapus semua yang tidak terpakai (comprehensive)
              docker system prune -af --volumes || true
              echo "‚úÖ Docker cleanup completed"
            else
              echo "‚ÑπÔ∏è Docker tidak terinstall, skip Docker cleanup"
            fi
            
            # Cleanup old backups (keep last 7 days)
            echo "üì¶ Cleaning up old backups..."
            find /var/backups -name "jargas-backend-dev-*" -type d -mtime +7 -exec rm -rf {} + 2>/dev/null || true
            find /var/backups -name "jargas-db-*.sql" -type f -mtime +7 -delete 2>/dev/null || true
            echo "‚úÖ Old backups cleanup completed (kept last 7 days)"
            
            # Cleanup old logs (keep last 14 days)
            echo "üìù Cleaning up old logs..."
            find /var/log -name "jargas-backend-dev*.log" -type f -mtime +14 -delete 2>/dev/null || true
            find /var/log -name "jargas-backend-dev*.log.*" -type f -mtime +14 -delete 2>/dev/null || true
            echo "‚úÖ Old logs cleanup completed (kept last 14 days)"
            
            # Cleanup Python cache di deployment directory
            echo "üêç Cleaning up Python cache..."
            find /var/www/jargas-backend-dev -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
            find /var/www/jargas-backend-dev -type f -name "*.pyc" -delete 2>/dev/null || true
            find /var/www/jargas-backend-dev -type f -name "*.pyo" -delete 2>/dev/null || true
            echo "‚úÖ Python cache cleanup completed"
            
            # Cleanup pip cache
            echo "üì¶ Cleaning up pip cache..."
            pip cache purge 2>/dev/null || true
            echo "‚úÖ Pip cache cleanup completed"
            
            # Cleanup system temporary files
            echo "üóëÔ∏è Cleaning up temporary files..."
            find /tmp -name "jargas-*" -type f -mtime +1 -delete 2>/dev/null || true
            find /tmp -name "*jargas*" -type d -mtime +1 -exec rm -rf {} + 2>/dev/null || true
            echo "‚úÖ Temporary files cleanup completed"
            
            # Show disk usage
            echo "üíæ Current disk usage:"
            df -h / | tail -1
            echo "‚úÖ Cleanup process completed!"

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            
            echo "üöÄ Starting deployment to development server..."
            
            # Navigate to deployment directory
            cd ${{ env.DEPLOY_PATH }} || {
              echo "‚ùå Directory ${{ env.DEPLOY_PATH }} tidak ditemukan!"
              echo "üí° Membuat directory baru..."
              mkdir -p ${{ env.DEPLOY_PATH }}
              cd ${{ env.DEPLOY_PATH }}
              git clone https://github.com/${{ github.repository }}.git .
              git checkout dev
            }
            
            # Backup current deployment (optional)
            echo "üì¶ Creating backup..."
            BACKUP_DIR="/var/backups/jargas-backend-dev-$(date +%Y%m%d-%H%M%S)"
            mkdir -p "$BACKUP_DIR"
            cp -r . "$BACKUP_DIR/" 2>/dev/null || echo "Backup skipped (first deployment)"
            
            # Pull latest code
            echo "üì• Pulling latest code from dev branch..."
            git fetch origin
            git reset --hard origin/dev
            git clean -fd
            
            # Setup virtual environment if not exists
            if [ ! -d "venv" ]; then
              echo "üêç Creating virtual environment..."
              python3 -m venv venv
            fi
            
            # Activate virtual environment and install dependencies
            echo "üì¶ Installing/updating dependencies..."
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
            
            # Setup environment file if not exists
            if [ ! -f ".env.dev" ]; then
              echo "‚öôÔ∏è Creating .env.dev from example..."
              cp env.dev.example .env.dev
              echo "‚ö†Ô∏è WARNING: Please configure .env.dev file manually!"
            fi
            
            # Run database migration
            echo "üîÑ Running database migration..."
            python -m scripts.smart_migrate --mode sequential || {
              echo "‚ö†Ô∏è Migration failed, but continuing..."
              python -m scripts.smart_migrate --status
            }
            
            # Restart backend service
            echo "üîÑ Restarting backend service..."
            if systemctl is-active --quiet jargas-backend-dev.service; then
              systemctl restart jargas-backend-dev.service
              echo "‚úÖ Service restarted"
            elif systemctl is-enabled --quiet jargas-backend-dev.service 2>/dev/null; then
              systemctl start jargas-backend-dev.service
              echo "‚úÖ Service started"
            else
              echo "‚ö†Ô∏è Service jargas-backend-dev.service tidak ditemukan"
              echo "üí° Starting backend manually..."
              # Kill existing process if running
              pkill -f "uvicorn.*app.main:app.*8020" || true
              # Start backend in background
              nohup venv/bin/python run.py > /var/log/jargas-backend-dev.log 2>&1 &
              echo "‚úÖ Backend started manually"
            fi
            
            # Wait a bit for service to start
            sleep 3
            
            # Health check
            echo "üè• Performing health check..."
            if curl -f http://localhost:8020/health > /dev/null 2>&1; then
              echo "‚úÖ Health check passed!"
            else
              echo "‚ö†Ô∏è Health check failed, but deployment completed"
              echo "üí° Check logs: tail -f /var/log/jargas-backend-dev.log"
            fi
            
            echo "‚úÖ Deployment completed successfully!"
            
            # Final cleanup after successful deployment
            echo "üßπ Running final cleanup..."
            # Cleanup Python cache again
            find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
            find . -type f -name "*.pyc" -delete 2>/dev/null || true
            # Cleanup pip cache in venv
            if [ -d "venv" ]; then
              venv/bin/pip cache purge 2>/dev/null || true
            fi
            echo "‚úÖ Final cleanup completed"

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "üîç Verifying deployment..."
            sleep 5
            curl -f http://localhost:8020/health || echo "‚ö†Ô∏è Health check failed"
            curl -f http://localhost:8020/ || echo "‚ö†Ô∏è Root endpoint check failed"

